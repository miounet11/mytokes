# åŠŸèƒ½è§„åˆ’ï¼šå¤šç»ˆç«¯ä¼šè¯éš”ç¦»

## ğŸ“‹ æ¦‚è¿°

### åŠŸèƒ½ç›®æ ‡
è§£å†³åŒä¸€å®¢æˆ·ç«¯å¤šå¼€ç»ˆç«¯æ—¶ï¼Œä¸åŒç»ˆç«¯çš„å¯¹è¯å†å²å’ŒçŠ¶æ€ç›¸äº’æ··æ·†çš„é—®é¢˜ã€‚

### é¢„æœŸä»·å€¼
- ç”¨æˆ·å¯ä»¥åœ¨å¤šä¸ªç»ˆç«¯çª—å£åŒæ—¶è¿›è¡Œç‹¬ç«‹çš„ AI å¯¹è¯
- æ¯ä¸ªç»ˆç«¯çš„ä¸Šä¸‹æ–‡ã€å†å²è®°å½•å®Œå…¨éš”ç¦»
- æå‡å¤šä»»åŠ¡å¹¶è¡Œå·¥ä½œçš„ç”¨æˆ·ä½“éªŒ

### å½±å“èŒƒå›´
- `api_server.py` - æ ¸å¿ƒ API æœåŠ¡
- `src/ai_history_manager/manager.py` - HistoryManager ç±»

---

## ğŸ” é—®é¢˜æ ¹å› åˆ†æ

### å®é™…é—®é¢˜ï¼ˆé€šè¿‡æ—¥å¿—ç¡®è®¤ï¼‰

ä»æœåŠ¡å™¨æ—¥å¿—ä¸­å‘ç°ï¼š

```log
[cf097439f5dbef37] ğŸ¯ ä¸Šä¸‹æ–‡å¢å¼ºå®Œæˆ  # æ­£å¸¸çš„ session_id
[default] ğŸ¯ ä¸Šä¸‹æ–‡å¢å¼ºå®Œæˆ          # âŒ é—®é¢˜ï¼
[default] ğŸ¯ ä¸Šä¸‹æ–‡å¢å¼ºå®Œæˆ          # âŒ å¤šä¸ªè¯·æ±‚å…±äº« "default"
```

#### æ ¹æœ¬åŸå› ï¼šsession_id å›é€€åˆ° "default"

```python
# api_server.py:877-911
def generate_session_id(messages: list[dict], working_dir: str = "") -> str:
    content_parts = []

    # 1. å·¥ä½œç›®å½•ä½œä¸ºä¸»è¦éš”ç¦»ä¾æ®
    if working_dir:
        content_parts.append(f"cwd:{working_dir}")

    # 2. æ¶ˆæ¯å†…å®¹ä½œä¸ºè¾…åŠ©
    if not messages:
        if content_parts:
            return hashlib.md5("...").hexdigest()[:16]
        return "default"  # âŒ é—®é¢˜åœ¨è¿™é‡Œï¼
```

**é—®é¢˜åœºæ™¯ï¼š**

1. Claude Code CLI åœ¨æŸäº›æƒ…å†µä¸‹**ä¸å‘é€** `X-Working-Directory` è¯·æ±‚å¤´
2. å½“ `working_dir` ä¸ºç©ºä¸” `messages` ä¸ºç©ºæ—¶ï¼Œè¿”å› `"default"`
3. æ‰€æœ‰è¿™äº›è¯·æ±‚å…±äº«åŒä¸€ä¸ª `session_id = "default"`
4. å¯¼è‡´ä¸åŒç»ˆç«¯çš„ä¸Šä¸‹æ–‡å’Œæ‘˜è¦æ··æ·†

#### å½“å‰æ¶æ„ï¼ˆå®é™…ä¸Šæ˜¯æ­£ç¡®çš„ï¼‰

```python
# api_server.py:3232
manager = HistoryManager(HISTORY_CONFIG, cache_key=session_id)
```

- `HistoryManager` æ¯ä¸ªè¯·æ±‚åˆ›å»ºæ–°å®ä¾‹ âœ…
- `_session_contexts` æŒ‰ session_id éš”ç¦» âœ…
- é—®é¢˜ä¸åœ¨æ¶æ„ï¼Œè€Œåœ¨ **session_id ç”Ÿæˆé€»è¾‘**

### é—®é¢˜è¡¨ç°

| åœºæ™¯ | é—®é¢˜è¡¨ç° |
|------|----------|
| ç»ˆç«¯ A å’Œ B åŒæ—¶å¯¹è¯ | A çš„å†å²æ¶ˆæ¯å‡ºç°åœ¨ B çš„ä¸Šä¸‹æ–‡ä¸­ |
| ç»ˆç«¯ A è§¦å‘å†å²æˆªæ–­ | B çš„å†å²ä¹Ÿè¢«æˆªæ–­ |
| ç»ˆç«¯ A è§¦å‘æ‘˜è¦ | æ‘˜è¦å†…å®¹æ··å…¥ B çš„å¯¹è¯ |

---

## ğŸ¯ åŠŸèƒ½åˆ†è§£

### æ ¸å¿ƒä»»åŠ¡

- [x] **T1: ä¿®å¤ `generate_session_id` å‡½æ•°** âœ…
  - æ·»åŠ  `client_ip` å’Œ `client_port` å‚æ•°
  - å½“ `working_dir` ä¸ºç©ºæ—¶ï¼Œä½¿ç”¨å®¢æˆ·ç«¯æ ‡è¯†
  - æœ€åçš„åå¤‡æ–¹æ¡ˆï¼šç”Ÿæˆéšæœº IDï¼ˆè€Œä¸æ˜¯ "default"ï¼‰

- [x] **T2: æ›´æ–° API ç«¯ç‚¹è°ƒç”¨** âœ…
  - `/v1/messages` ç«¯ç‚¹ï¼šä¼ å…¥å®¢æˆ·ç«¯ IP å’Œç«¯å£
  - `/v1/chat/completions` ç«¯ç‚¹ï¼šä¼ å…¥å®¢æˆ·ç«¯ IP å’Œç«¯å£

- [ ] **T3: æµ‹è¯•éªŒè¯**
  - åŒä¸€ç›®å½•ä¸‹å¤šç»ˆç«¯æµ‹è¯•
  - ä¸åŒç›®å½•ä¸‹å¤šç»ˆç«¯æµ‹è¯•
  - æ—  `X-Working-Directory` è¯·æ±‚å¤´æµ‹è¯•

---

## ğŸ“ æŠ€æœ¯æ–¹æ¡ˆ

### æ–¹æ¡ˆé€‰æ‹©ï¼šä¿®å¤ session_id ç”Ÿæˆé€»è¾‘

é—®é¢˜åœ¨äº `generate_session_id` å‡½æ•°ä¼šå›é€€åˆ° `"default"`ï¼Œå¯¼è‡´å¤šä¸ªç»ˆç«¯å…±äº«åŒä¸€ä¸ª session_idã€‚

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ¨è |
|------|------|------|------|
| A: ä½¿ç”¨å®¢æˆ·ç«¯ IP + ç«¯å£ | ç®€å•ï¼Œæ— éœ€å®¢æˆ·ç«¯æ”¹åŠ¨ | ä»£ç†/NAT ç¯å¢ƒå¯èƒ½ä¸å‡†ç¡® | âœ… |
| B: è¦æ±‚å®¢æˆ·ç«¯å‘é€ X-Session-ID | æœ€å‡†ç¡® | éœ€è¦å®¢æˆ·ç«¯æ”¯æŒ | âŒ |
| C: æœåŠ¡ç«¯ç”Ÿæˆå¹¶é€šè¿‡ Cookie è¿”å› | æŒä¹…åŒ– | HTTP æ— çŠ¶æ€ï¼Œå¤æ‚ | âŒ |

**æ¨èæ–¹æ¡ˆ A**ï¼šä½¿ç”¨å®¢æˆ·ç«¯ IP + ç«¯å£ä½œä¸ºåå¤‡æ ‡è¯†

### ä¿®å¤æ–¹æ¡ˆ

```python
# api_server.py:877 ä¿®æ”¹å‰
def generate_session_id(messages: list[dict], working_dir: str = "") -> str:
    # ...
    return "default"  # âŒ é—®é¢˜

# ä¿®æ”¹å
def generate_session_id(
    messages: list[dict],
    working_dir: str = "",
    client_ip: str = "",
    client_port: int = 0
) -> str:
    content_parts = []

    # 1. å·¥ä½œç›®å½•ï¼ˆæœ€ä¼˜å…ˆï¼‰
    if working_dir:
        content_parts.append(f"cwd:{working_dir}")

    # 2. å®¢æˆ·ç«¯æ ‡è¯†ï¼ˆåå¤‡æ–¹æ¡ˆï¼‰
    if not content_parts and client_ip:
        content_parts.append(f"client:{client_ip}:{client_port}")

    # 3. æ¶ˆæ¯å†…å®¹ï¼ˆè¾…åŠ©ï¼‰
    for msg in messages[:3]:
        content = msg.get("content", "")
        if isinstance(content, str):
            content_parts.append(content[:100])

    if content_parts:
        return hashlib.md5("".join(content_parts).encode()).hexdigest()[:16]

    # 4. æœ€åçš„åå¤‡ï¼šç”Ÿæˆéšæœº IDï¼ˆè€Œä¸æ˜¯ "default"ï¼‰
    return f"anon_{uuid.uuid4().hex[:12]}"
```

### è°ƒç”¨æ–¹å¼ä¿®æ”¹

```python
# api_server.py:3172 (@app.post("/v1/messages"))

# ä¿®æ”¹å‰
working_dir = request.headers.get("X-Working-Directory", "")
session_id = generate_session_id(messages, working_dir)

# ä¿®æ”¹å
working_dir = request.headers.get("X-Working-Directory", "")
client_ip = request.client.host if request.client else ""
client_port = request.client.port if request.client else 0
session_id = generate_session_id(messages, working_dir, client_ip, client_port)
```

### é…ç½®å‚æ•°

```python
# åœ¨ HISTORY_CONFIG ä¸­æ·»åŠ 
SESSION_CONFIG = {
    "max_sessions": 1000,           # æœ€å¤§ä¼šè¯æ•°
    "session_ttl": 3600,            # ä¼šè¯è¿‡æœŸæ—¶é—´(ç§’)
    "cleanup_interval": 300,        # æ¸…ç†é—´éš”(ç§’)
}
```

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

| éªŒæ”¶é¡¹ | æ ‡å‡† |
|--------|------|
| ä¼šè¯éš”ç¦» | ä¸åŒ session_id çš„è¯·æ±‚å†å²å®Œå…¨éš”ç¦» |
| å‘åå…¼å®¹ | ä¸ä¼  session_id æ—¶æœåŠ¡æ­£å¸¸å·¥ä½œï¼ˆä½¿ç”¨ "default"ï¼‰ |
| ä¼šè¯æ¢å¤ | åŒä¸€ session_id å¯æ¢å¤ä¹‹å‰çš„å¯¹è¯ä¸Šä¸‹æ–‡ |
| è¿‡æœŸæ¸…ç† | è¶…æ—¶ä¼šè¯è‡ªåŠ¨æ¸…ç†ï¼Œé‡Šæ”¾å†…å­˜ |

### æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ |
|------|------|
| ä¼šè¯åˆ›å»ºå»¶è¿Ÿ | < 1ms |
| å†…å­˜å ç”¨ | æ¯ä¼šè¯ < 10MB (å«å†å²) |
| æœ€å¤§å¹¶å‘ä¼šè¯ | 1000+ |

### æµ‹è¯•ç”¨ä¾‹

```python
def test_session_isolation():
    """æµ‹è¯•ä¼šè¯éš”ç¦»"""
    hm = HistoryManager(config)

    # ä¼šè¯ A æ·»åŠ æ¶ˆæ¯
    hm.add_messages([{"role": "user", "content": "Hello A"}], session_id="session_a")

    # ä¼šè¯ B æ·»åŠ æ¶ˆæ¯
    hm.add_messages([{"role": "user", "content": "Hello B"}], session_id="session_b")

    # éªŒè¯éš”ç¦»
    assert len(hm.get_messages(session_id="session_a")) == 1
    assert len(hm.get_messages(session_id="session_b")) == 1
    assert hm.get_messages(session_id="session_a")[0]["content"] == "Hello A"
    assert hm.get_messages(session_id="session_b")[0]["content"] == "Hello B"
```

---

## â±ï¸ å®æ–½è®¡åˆ’

### é˜¶æ®µ 1ï¼šä¿®å¤ session_id ç”Ÿæˆ
1. ä¿®æ”¹ `generate_session_id` å‡½æ•°ç­¾å
2. æ·»åŠ å®¢æˆ·ç«¯æ ‡è¯†é€»è¾‘
3. ç§»é™¤ `"default"` å›é€€

### é˜¶æ®µ 2ï¼šæ›´æ–° API è°ƒç”¨
1. ä¿®æ”¹ `/v1/messages` ç«¯ç‚¹
2. ä¿®æ”¹ `/v1/chat/completions` ç«¯ç‚¹
3. ä» `request.client` è·å– IP å’Œç«¯å£

### é˜¶æ®µ 3ï¼šæµ‹è¯•éªŒè¯
1. å¤šç»ˆç«¯å¹¶å‘æµ‹è¯•
2. æ£€æŸ¥æ—¥å¿—ç¡®è®¤ä¸å†å‡ºç° `[default]`

---

## ğŸ“ è¿­ä»£å†å²

### v2 - 2026-02-02
- æ·±å…¥åˆ†æå‘ç°å·²æœ‰ `generate_session_id` å‡½æ•°
- ç®€åŒ–æ–¹æ¡ˆï¼šç›´æ¥é‡æ„ HistoryManager å†…éƒ¨
- å‡å°‘æ”¹åŠ¨é‡å’Œé£é™©

### v1 - 2026-02-02
- åˆå§‹ç‰ˆæœ¬
- å®Œæˆé—®é¢˜åˆ†æå’ŒæŠ€æœ¯æ–¹æ¡ˆè®¾è®¡
